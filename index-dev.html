<!doctype html>
<!--
Copyright (c) 2013, Empirical Modelling Group
All rights reserved.

See LICENSE.txt
-->

<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=0.9">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="theme-color" content="#132023" />
	<title>JS-EDEN</title>

	<link rel="stylesheet" type="text/css" href="css/jseden.css">
	<link rel="stylesheet" type="text/css" href="css/jquery-ui-1.9.2.custom.min.css">
	<link rel="stylesheet" type="text/css" href="css/eden.css">
	<link rel="stylesheet" type="text/css" href="css/menu-bar.css">
	<link rel="stylesheet" type="text/css" href="plugins/symbol-viewer/symbol-viewer.css">
	<link rel="stylesheet" type="text/css" href="css/contextmenu.css" />
	<link rel="stylesheet" type="text/css" href="css/highlighter.css" />
	<link rel="stylesheet" type="text/css" href="css/scriptbox.css" />
	<link rel="stylesheet" type="text/css" href="css/mobiletabs.css" />

	<script type="text/javascript" src="js/lib/jquery-1.8.3.min.js"></script>
	<script type="text/javascript" src="js/lib/jquery-ui-1.9.2.custom.min.js"></script>
	<style type="text/css">
		/*If we ever upgrade to jquery.ui version 1.10 or later then remove the following rule. */
		.ui-front {
			z-index: 10000 !important;
		}

		div.jseden-dialog-plisting {
			box-sizing: border-box;
			padding-top: 20px;
			padding-bottom:30px;
			padding-left: 80px;
			padding-right: 80px;
			/*border: 1px solid #eee;*/
			width: 100%;
			height: 100%;
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			justify-content: left;
			overflow-y: auto;
		}

		div.jseden-project-cat {
			margin-left: 80px;
			font-size: 16pt;
			font-family: Roboto,Arial,sans-serif;
			color: #666;
			font-weight: bold;
		}

		hr.jseden-project-cat {
			border: 1px solid #b5b5f5;
		}

		div.cadence-plisting-entry {
			width: 200px;
			height: 150px;
			margin: 5px;
			background-repeat: no-repeat;
			cursor: pointer;
			color: #132023;
		}

		div.cadence-plisting-entry.special {
			height: 100px;
		}

		div.cadence-plisting-icon {
			border: 1px solid #eee;
			font-family: "FontAwesome";
			font-size: 60px;
			background: #d0f0f5;
			cursor: pointer;
			text-align: center;
			padding-top: 10px;
			padding-bottom: 10px;
			height: 95px;
		}

		div.cadence-plisting-img {
			border: 1px solid #eee;
			background: white;
			cursor: pointer;
			text-align: center;
			/*height: 112;*/
		}

		div.cadence-plisting-icon.special {
			background: #f5f5d0;
			height: 60px;
		}

		div.cadence-plisting-title {
			font-weight: bold;
			font-family: Roboto,Arial,sans-serif;
			color: #424249;
			font-size: 14px;
			line-height: 16px;
			padding-left: 2px;
			margin-top: 8px;
		}

		div.cadence-plisting-subtitle {
			font-family: Roboto,Arial,sans-serif;
			color: #525259;
			font-size: 12px;
			line-height: 16px;
			padding-left: 2px;
		}

		div.cadence-plisting-entry:hover {
			color: #29454B;
		}

		div.cadence-plisting-entry:hover .cadence-plisting-icon {
			border-color: #222;
			background-color: white;
		}

		div.cadence-plisting-entry:hover .cadence-plisting-img {
			border-color: #222;
			background-color: white;
		}

		div.importdialog {
			position: absolute;
			top: 65px;
			right: 150px;
			width: 400px;
			height: 200px;
			background: #f5f5f5;
			border-bottom-left-radius: 6px;
			border-bottom-right-radius: 6px;
			box-shadow: 0 0 15px #4a6887;
			font-size: 12pt;
			color: black;
		}

		span.importdialog-icon {
			font-family: "FontAwesome";
			margin-right: 20px;
		}

		div.importdialog-title {
			font-size: 16pt;
			font-weight: bold;
			margin-top: 20px;
			margin-left: 20px;
			color: #666;
		}

		div.importdialog-content {
			margin: 20px;
			color: black;
		}

	</style>
</head>
<body>

<script src="js/lib/jquery.color.js"></script>
<script src="js/lib/jquery.hotkeys.js"></script>
<script src="js/lib/json2.js"></script>
<script src="js/lib/diff_match_patch.js"></script>
<script src="js/core/runtime.js"></script>
<script src="js/dummyconsole.js"></script>
<script src="js/arrayCompareFix.js"></script>
<script src="js/core/window-highlighter.js"></script>
<script src="js/core/maintainer.js"></script>
<script src="js/core/definition.js"></script>
<script src="js/core/polyglot.js"></script>
<script src="js/core/translator.js"></script>
<script src="js/core/eden.js"></script>
<script src="js/core/database.js"></script>
<script src="js/core/plugins.js"></script>
<script src="js/query.js"></script>
<script src="js/util/url.js"></script>
<script src="js/core/initialise.js"></script>
<script src="js/core/lex.js"></script>
<script src="js/core/errors.js"></script>
<script src="js/core/warnings.js"></script>
<script src="js/core/translator2.js"></script>
<script src="js/core/ast.js"></script>
<script src="js/core/statements.js"></script>
<script src="js/language/lang.js"></script>
<script src="js/wrappers.js"></script>
<script src="js/util/css.js"></script>
<script src="js/ui/highlighter.js"></script>
<script src="js/ui/contextmenu.js"></script>
<script src="js/ui/buttonbar.js"></script>
<script src="js/ui/mobiletabs.js"></script>
<script src="js/ui/scriptbox.js"></script>
<script src="js/ui/scriptview.js"></script>
<script src="js/ui/svgview.js"></script>
<script src="js/ui/menubar.js"></script>
<script src="plugins/symbol-viewer/symbol-viewer.js"></script>


<script type="text/javascript">
	var projects;

	function get_time_diff( timestamp )
	{
		var datetime = timestamp * 1000;
		var now = Date.now();
		var _date = new Date();
		var _userOffset = _date.getTimezoneOffset()*60000;
		datetime -= _userOffset;

		if( isNaN(datetime) )
		{
		    return "";
		}

		if (datetime < now) {
		    var milisec_diff = now - datetime;
		}else{
		    var milisec_diff = datetime - now;
		}

		var days = Math.floor(milisec_diff / 1000 / 60 / (60 * 24));

		var date_diff = new Date( milisec_diff );

		if (days > 5) {
			return (new Date(datetime)).toDateString();
		} else {
			var result = "";
			if (days > 0) {
				result += days;
				if (days > 1) {
					result += " days ago";
				} else {
					result += " day ago";
				}
			} else {
				if (date_diff.getUTCHours() > 0) {
					var hours = date_diff.getUTCHours();
					result += hours;
					if (hours > 1) {
						result += " hours ago";
					} else {
						result += " hour ago";
					}
				} else {
					var mins = date_diff.getUTCMinutes();
					if (mins > 0) {
						result += mins;
						if (mins > 1) {
							result += " minutes ago";
						} else {
							result += " minute ago";
						}
					} else {
						var secs = date_diff.getUTCSeconds();
						result += secs;
						if (secs > 1) {
							result += " seconds ago";
						} else {
							result += " seconds ago";
						}
					}
				}
			}
			return result;
		}
	}

	Construit(undefined, function(loaded) {
		$(".loaddialog").remove();
		if (!loaded) {
			console.log("NOT LOADED");
			var lopts = $("#loadoptions");
			/*if (!Eden.restore()) {
				Eden.loadFromURL("library2/NewProject.js-e");
			}*/

			lopts.css("display","block");
			lopts.on("click","#restoreold",function() {
				Eden.restore();
				lopts.css("display","none");
			})
			.on("click","#loadnew",function() {
				Eden.loadFromURL("library2/NewProject.js-e");
				lopts.css("display","none");
			})
			.on("click","#importfile",function() {
				//Eden.loadFromURL("library2/NewProject.js-e");
				lopts.css("display","none");
				var importfile = $("#importdialog");
				importfile.css("display","block");

				importfile.on("click","#closeimport",function() {
					importfile.css("display","none");
					lopts.css("display","block");
				})
				.on("click","#openfile",function() {
					var fileinput = $("#theimportfile").get(0);
					var file = fileinput.files[0];
					var reader = new FileReader();
					reader.onload = function(e) {
						Eden.loadFromString(e.target.result);
						importfile.css("display","none");
					};
					reader.readAsText(file);
				});
			})
			.on("click",".project",function(e) {
				var path = e.currentTarget.getAttribute("data-path");
				var tag = parseInt(e.currentTarget.getAttribute("data-tag"));
				console.log("Load project: " + path + "@"+tag);
				Eden.load(path,tag,function() {
					lopts.css("display","none");
				});
			});

			function displayProjects(pub, cb) {
				var user = (pub)?"public" : ((Eden.DB.username) ? Eden.DB.username.split(" ").join("") : "public");
				var path = "jseden2/"+user;
				var plist = (pub) ? lopts.find("#jseden-public-projects") : lopts.find("#jseden-private-projects");

				console.log("Load projects: " + path);

				Eden.DB.getDirectory(path, function(data) {
					var ordered = [];

					for (var x in data) {
						ordered.push(path+"/"+x);
					}

					console.log(data);

					ordered.sort(function(a,b) {
						var t = Eden.DB.meta[a].date.split(/[- :]/);
						var da = (new Date(t[0], t[1]-1, t[2], t[3], t[4], t[5])).getTime()/1000;
						t = Eden.DB.meta[b].date.split(/[- :]/);
						var db = (new Date(t[0], t[1]-1, t[2], t[3], t[4], t[5])).getTime()/1000;
						return da < db;
					});

					for (var i=0; i<ordered.length; i++) {
						var meta = Eden.DB.meta[ordered[i]];
						var t = meta.date.split(/[- :]/);
						var title = meta.title;
						var thumb = undefined;
						if (title.charAt(0) == "{") {
							var decoded = JSON.parse(title);
							title = decoded.title;
							thumb = decoded.thumb;
						}

						var subtitle;
						if (pub) {
							subtitle = meta.author;
						} else {
							subtitle = get_time_diff((new Date(t[0], t[1]-1, t[2], t[3], t[4], t[5])).getTime()/1000);
						}

						//Eden.DB.getMeta(path+"/"+x,function(path,meta) {
						if (thumb) {
							plist.append($('<div class="cadence-plisting-entry project noselect" data-path="'+(ordered[i])+'" data-tag="'+meta.latestID+'"><div class="cadence-plisting-img"><img src="'+thumb+'"></img></div><div class="cadence-plisting-title">'+title+'</div><div class="cadence-plisting-subtitle">'+subtitle+'</div></div>'));
						} else {
							plist.append($('<div class="cadence-plisting-entry project noselect" data-path="'+(ordered[i])+'" data-tag="'+meta.latestID+'"><div class="cadence-plisting-icon">&#xf0c3;</div><div class="cadence-plisting-title">'+title+'</div><div class="cadence-plisting-subtitle">'+subtitle+'</div></div>'));
							//console.log(Eden.DB.meta[path+"/"+x]);
						}
						//});
					}

					projects = ordered;
					if (cb) cb(ordered);
				});
			}

			displayProjects(true, function() {
				if (Eden.DB.isLoggedIn()) {
					displayProjects();
				}
			});

			Eden.DB.listenTo("login", this, function(name) {
				displayProjects();
			});

			Eden.DB.listenTo("logout", this, function() {
				var plist = lopts.find(".jseden-dialog-plisting").get(0);
				var node = plist.firstChild;
				while (node) {
					var next = node.nextSibling;
					if (node.className == "cadence-plisting-entry project noselect") plist.removeChild(node);
					node = next;
				}

				displayProjects(true);
			});
		}
	});
</script>

<div class="loaddialog">
<!--img src="images/construit_logo_2.png"/-->
<div class="mainloader">Loading...</div>
<div class="loadmessage">Loading...</div>
</div>

<div id="loadoptions" class="modal" style="display: none;">
	<div class="modal-content" style="padding: 20px 0;">
		<div class="searchouter"><input type="text" class="search" placeholder="Search..."></input></div>
		<div class="jseden-dialog-plisting">
			<div id="loadnew" class="cadence-plisting-entry noselect special"><div class="cadence-plisting-icon special">&#xf067;</div><div class="cadence-plisting-title">New Project</div></div>
			<div id="importfile" class="cadence-plisting-entry noselect special"><div class="cadence-plisting-icon special">&#xf07c;</div><div class="cadence-plisting-title">Import File</div></div>
			<div id="restoreold" class="cadence-plisting-entry noselect special"><div class="cadence-plisting-icon special">&#xf01e;</div><div class="cadence-plisting-title">Restore Last</div></div>
		</div>
		<hr class="jseden-project-cat" /><div class="jseden-project-cat">Published:</div>
		<div id="jseden-public-projects" class="jseden-dialog-plisting">

		</div>
		<hr class="jseden-project-cat" /><div class="jseden-project-cat">Your Projects:</div>
		<div id="jseden-private-projects" class="jseden-dialog-plisting">

		</div>
	</div>
</div>

<div id="importdialog" class="modal" style="display: none">
	<div class="modal-content" style="width: 300px;">
		<div class="importdialog-title"><span class="importdialog-icon">&#xf07c;</span>Import File</div>
		<div class="importdialog-content">
		<input id="theimportfile" type="file"></input><br/><br/>
		<div style="text-align: center; margin-top: 20px;"><button class="jseden" id="openfile">Import</button><button class="jseden" id="closeimport">Cancel</button></div>
		</div>
	</div>
</div>

<div id="tooltip" style="display:none"></div>
</body>
</html>
